# 视频解码总结

视频解码一直是安防行业的痛点，视频解码本身就需要耗费大量的计算资源。特别是现在安防相机的分辨率达到了4k及以上，需要的计算资源是巨量的

***

### 安防业视频处理的流程

视频裸流从摄像头生成后，通过通用协议（GB28181，ONVIF）传输裸流，注意这部分是不会传输YUV视频的，一是因为协议里规定的数据格式不是YUV，而是H264等格式的裸流，商家没必要在协议的基础上再多加YUV的传输，二是因为YUV视频的数据量是远大于裸流文件的，如果每一帧都传输YUV图像数据，那么网络带宽难以承受。

客户端接收到裸流文件后，需要解析成一帧一帧的图像，通常的做法是H264 --> YUV --> other。因为图像分辨率太高，所以这部分计算量很大。当然也可以跳过YUV，直接从H264-->other(cv::Mat)。

***

### 视频解码速度(3392*2008)

#### 软解

浩腾服务器：1.7GHz*15，纯软解码只能流畅解码3路

公司服务器：2.1GHz*32，纯软解码只能流畅解码12路

华为VCM服务器：2.2GHz*40，待测试

#### 硬解

浩腾服务器：TITAN XP，纯硬解码也只能解码3路

mini box：1070，纯解码只能解码1路，2路就会稍微跳

* 理论上解码路数不会这么少，按照换算，TITAN P4 可以解码5.67路，但是可能涉及到与多路之间的资源调用和CPU的内存交换导致解码少于实际

#### 核显解码

老师电脑：150-180帧每秒   ---------   GTX1080：250帧每秒

### 结论

CPU软解和GPU硬解效率都不是很高，而且成本高，核显解码是个比较好的方向

***

### 现在使用的解码方法

从SDK获取裸码流H264，将裸码流push到队列中，队列长度阈值为5，超过阈值清空

开启线程循环获取队列中的裸码流，通过ffmpeg将H264码流转成cv::Mat

ffmpeg中可以设置软解码、硬解码的参数

* 这样做可以避免处理速度跟不上流的速度导致的花屏现象，但是视频可能跳段

***

### 解码+业务计算测试(浩腾服务器)

|    解码路数     | 测试时间(s) | 跳段次数(次) | 平均跳段时间(s) |
| :---------: | :-----: | :-----: | :-------: |
|    3路CPU    |  5216   |  7260   |   2.16    |
|    3路GPU    |   696   |   945   |   2.21    |
| 2路GPU+2路CPU |  2251   |  4161   |   2.16    |
|    2路GPU    |   650   |   172   |   7.57    |
|    2路CPU    |   467   |   328   |   2.85    |
| 2路GPU+1路CPU |   690   |   913   |   2.27    |
| 1路GPU+2路CPU |   327   |   331   |   2.96    |
| 1路GPU+1路CPU |   389   |   192   |   4.05    |
|    1路GPU    |   915   |    4    |  228.75   |
|    1路CPU    |   376   |   11    |    34     |

* 跳段都会发生，推荐使用2路GPU+2路CPU

***

### 推荐服务器配置

配置专门的核显解码服务器，解码出数据再给业务服务器计算

***

### 后续工作

#### 测试VCM5020软解能力

已经与华为沟通，他们再协调测试的机器

测试的出VCM5020能够软解码15路视频

#### VCM5020服务器使用方案

如果测试VCM软解能力够15路的话，就不调用GPU解码了，因为一块GPU也解不了几路，还不如空出来提高抓拍精度

#### 人脸识别、对比

#### 全车信息



